<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAT-DISCOVERY - Satellite Discovery Platform</title>
    <link rel="stylesheet" href="/css/theme.css">
    <link rel="stylesheet" href="/css/layout.css">
    <link rel="stylesheet" href="/css/components.css">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
</head>
<body>
    <header>
        <h1>üõ∞Ô∏è SAT-DISCOVERY</h1>
        <nav>
            <ul>
                <li><a href="#/">Dashboard</a></li>
                <li><a href="#sources">Sources</a></li>
                <li><a href="#orbit">Orbit Planner</a></li>
                <li><a href="#delivery">Data Delivery</a></li>
                <li><a href="/about.html">About</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <!-- Sidebar toggle button -->
        <button class="sidebar-toggle" id="sidebarToggle" title="Toggle Sidebar">
            <span class="toggle-icon">‚óÄ</span>
        </button>

        <!-- Sidebar with filters -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-section info-section">
                <div class="info-text">
                    <strong>üîç How to use:</strong><br>
                    ‚Ä¢ Press Ctrl+K to search<br>
                    ‚Ä¢ Use filters to narrow results<br>
                    ‚Ä¢ Click map to draw AOI<br>
                    ‚Ä¢ Enter coordinates to jump to location
                </div>
            </div>
            
            <div class="sidebar-section">
                <h3>Search</h3>
                <div class="input-group">
                    <input 
                        type="text" 
                        id="searchInput" 
                        class="input-field" 
                        placeholder="Search satellites... (Ctrl+K)"
                        title="Search by satellite name or operator (Ctrl+K to focus)"
                    >
                </div>
            </div>

            <div class="sidebar-section">
                <h3>Sensor Type</h3>
                <div class="checkbox-group" id="typeFilters" title="Filter by sensor type (Optical/SAR/Hyperspectral)">
                    <!-- Populated by JS -->
                </div>
            </div>

            <div class="sidebar-section">
                <h3>Archive</h3>
                <div class="radio-group" title="Filter by data archive availability">
                    <div class="radio-item">
                        <input type="radio" id="archiveAll" name="archive" value="all" checked>
                        <label for="archiveAll" title="Show all satellites">All</label>
                    </div>
                    <div class="radio-item">
                        <input type="radio" id="archiveYes" name="archive" value="yes">
                        <label for="archiveYes" title="Show only satellites with public archives">Public Archive</label>
                    </div>
                    <div class="radio-item">
                        <input type="radio" id="archiveNo" name="archive" value="no">
                        <label for="archiveNo" title="Show satellites without public archives">No Archive</label>
                    </div>
                </div>
            </div>

            <div class="sidebar-section">
                <h3>Tasking</h3>
                <div class="radio-group" title="Filter by tasking/programming availability">
                    <div class="radio-item">
                        <input type="radio" id="taskingAll" name="tasking" value="all" checked>
                        <label for="taskingAll" title="Show all satellites">All</label>
                    </div>
                    <div class="radio-item">
                        <input type="radio" id="taskingYes" name="tasking" value="yes">
                        <label for="taskingYes" title="Show satellites available for tasking">Available</label>
                    </div>
                    <div class="radio-item">
                        <input type="radio" id="taskingNo" name="tasking" value="no">
                        <label for="taskingNo" title="Show satellites not available for tasking">Not Available</label>
                    </div>
                </div>
            </div>

            <div class="sidebar-section">
                <h3>üìÖ Time Range</h3>
                <div class="date-range-inputs">
                    <label for="startDate" title="Filter satellites by acquisition/launch date">Start Date</label>
                    <input type="date" id="startDate" class="input-field" title="Select start date">
                    
                    <label for="endDate" title="Filter satellites by acquisition/launch date">End Date</label>
                    <input type="date" id="endDate" class="input-field" title="Select end date">
                </div>
                <div class="date-range-presets">
                    <button class="btn btn-sm" data-days="0" title="Set date range to today">Today</button>
                    <button class="btn btn-sm" data-days="7" title="Set date range to last 7 days">Last 7 days</button>
                    <button class="btn btn-sm" data-days="30" title="Set date range to last 30 days">Last 30 days</button>
                    <button class="btn btn-sm" data-days="90" title="Set date range to last 90 days">Last 90 days</button>
                </div>
            </div>

            <div class="sidebar-section">
                <h3>üìç Location</h3>
                <div class="coordinate-inputs">
                    <div class="input-row">
                        <label for="latInput" title="Enter latitude (-90 to 90)">Latitude:</label>
                        <input type="number" id="latInput" class="input-field" 
                               placeholder="e.g., 40.7128" step="0.0001" min="-90" max="90"
                               title="Enter latitude value between -90 and 90">
                    </div>
                    <div class="input-row">
                        <label for="lngInput" title="Enter longitude (-180 to 180)">Longitude:</label>
                        <input type="number" id="lngInput" class="input-field" 
                               placeholder="e.g., -74.0060" step="0.0001" min="-180" max="180"
                               title="Enter longitude value between -180 and 180">
                    </div>
                    <button class="btn btn-block btn-sm" id="goToLocationBtn" 
                            title="Navigate map to specified coordinates">Go to Location</button>
                </div>
            </div>

            <div class="sidebar-section">
                <button class="btn btn-block" id="clearFiltersBtn" 
                        title="Clear all active filters">Clear All Filters</button>
            </div>
        </aside>

        <!-- Main content area -->
        <div class="content">
            <!-- Map panel (70%) -->
            <div class="map-panel">
                <div id="map"></div>
            </div>

            <!-- Results panel (30%) -->
            <div class="results-panel">
                <div class="results-header">
                    <div class="results-count" id="resultsCount">0 satellites found</div>
                </div>
                <div class="filter-chips" id="filterChips"></div>
                <div class="results-grid" id="resultsGrid">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>
    </main>

    <footer>
        <p>SAT-DISCOVERY - Open Satellite Observation Capability Index | Reference Only | No Data Hosted</p>
    </footer>

    <!-- Load JavaScript modules -->
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    
    <script src="/js/storage.js"></script>
    <script src="/js/dataLoader.js"></script>
    <script src="/js/indexer.js"></script>
    <script src="/js/filters.js"></script>
    <script src="/js/ui.js"></script>
    <script src="/js/map.js"></script>
    <script src="/js/router.js"></script>

    <script>
        // Initialize the application
        async function init() {
            try {
                // Initialize sidebar toggle
                initSidebarToggle();

                // Show loading state
                UI.showLoading(document.getElementById('resultsGrid'));

                // Load data and build index
                await DataLoader.loadAll();
                await Indexer.buildIndex();

                // Initialize map
                MapManager.init('map');

                // Load saved AOI
                const savedAOI = Storage.loadAOI();
                if (savedAOI) {
                    MapManager.setAOI(savedAOI);
                }

                // Populate type filters
                const types = Indexer.getUniqueTypes();
                const typeFiltersContainer = document.getElementById('typeFilters');
                types.forEach(type => {
                    const div = document.createElement('div');
                    div.className = 'checkbox-item';
                    div.innerHTML = `
                        <input type="checkbox" id="type${type}" value="${type}">
                        <label for="type${type}">${type}</label>
                    `;
                    typeFiltersContainer.appendChild(div);

                    div.querySelector('input').addEventListener('change', (e) => {
                        Filters.toggleType(type);
                    });
                });

                // Setup search input
                const searchInput = document.getElementById('searchInput');
                let searchTimeout;
                searchInput.addEventListener('input', (e) => {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        Filters.setSearch(e.target.value);
                        if (e.target.value.trim()) {
                            Storage.addRecentSearch(e.target.value.trim());
                        }
                    }, 300);
                });
                
                // Add keyboard shortcut for search (Ctrl+K or Cmd+K)
                document.addEventListener('keydown', (e) => {
                    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                        e.preventDefault();
                        searchInput.focus();
                        searchInput.select();
                    }
                    
                    // Escape to clear search
                    if (e.key === 'Escape' && document.activeElement === searchInput) {
                        searchInput.value = '';
                        Filters.setSearch('');
                        searchInput.blur();
                    }
                });

                // Setup archive filter
                document.querySelectorAll('input[name="archive"]').forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        if (e.target.value === 'all') {
                            Filters.setArchive(null);
                        } else if (e.target.value === 'yes') {
                            Filters.setArchive(true);
                        } else {
                            Filters.setArchive(false);
                        }
                    });
                });

                // Setup tasking filter
                document.querySelectorAll('input[name="tasking"]').forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        if (e.target.value === 'all') {
                            Filters.setTasking(null);
                        } else if (e.target.value === 'yes') {
                            Filters.setTasking(true);
                        } else {
                            Filters.setTasking(false);
                        }
                    });
                });

                // Setup time range filter
                const startDateInput = document.getElementById('startDate');
                const endDateInput = document.getElementById('endDate');
                
                startDateInput.addEventListener('change', (e) => {
                    Filters.setTimeRange(e.target.value, endDateInput.value);
                });
                
                endDateInput.addEventListener('change', (e) => {
                    Filters.setTimeRange(startDateInput.value, e.target.value);
                });
                
                // Setup time range preset buttons
                document.querySelectorAll('.date-range-presets button').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const days = parseInt(btn.dataset.days);
                        const endDate = new Date();
                        const startDate = new Date();
                        startDate.setDate(endDate.getDate() - days);
                        
                        startDateInput.value = startDate.toISOString().split('T')[0];
                        endDateInput.value = endDate.toISOString().split('T')[0];
                        
                        Filters.setTimeRange(startDateInput.value, endDateInput.value);
                    });
                });
                
                // Setup location input
                document.getElementById('goToLocationBtn').addEventListener('click', () => {
                    const latInput = document.getElementById('latInput');
                    const lngInput = document.getElementById('lngInput');
                    const lat = parseFloat(latInput.value);
                    const lng = parseFloat(lngInput.value);
                    
                    if (isNaN(lat) || isNaN(lng)) {
                        alert('Please enter valid coordinates.\n\nLatitude: -90 to 90\nLongitude: -180 to 180');
                        return;
                    }
                    
                    if (lat < -90 || lat > 90) {
                        alert('Latitude must be between -90 and 90');
                        latInput.focus();
                        return;
                    }
                    
                    if (lng < -180 || lng > 180) {
                        alert('Longitude must be between -180 and 180');
                        lngInput.focus();
                        return;
                    }
                    
                    if (MapManager && MapManager.map) {
                        MapManager.map.setView([lat, lng], 10);
                        
                        // Remove previous temp marker
                        if (MapManager.tempMarker) {
                            MapManager.map.removeLayer(MapManager.tempMarker);
                        }
                        
                        // Add new marker
                        MapManager.tempMarker = L.marker([lat, lng]).addTo(MapManager.map)
                            .bindPopup(`
                                <strong>Selected Location</strong><br>
                                Latitude: ${lat.toFixed(4)}¬∞<br>
                                Longitude: ${lng.toFixed(4)}¬∞
                            `)
                            .openPopup();
                    } else {
                        alert('Map not initialized. Please refresh the page.');
                    }
                });

                // Setup clear filters button
                document.getElementById('clearFiltersBtn').addEventListener('click', () => {
                    Filters.clearAll();
                    searchInput.value = '';
                    startDateInput.value = '';
                    endDateInput.value = '';
                    document.getElementById('latInput').value = '';
                    document.getElementById('lngInput').value = '';
                    document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
                    document.getElementById('archiveAll').checked = true;
                    document.getElementById('taskingAll').checked = true;
                    if (MapManager && MapManager.tempMarker) {
                        MapManager.map.removeLayer(MapManager.tempMarker);
                        MapManager.tempMarker = null;
                    }
                });

                // Listen for filter changes
                Filters.onChange(() => {
                    updateResults();
                    Storage.saveFilters(Filters.getActive());
                });

                // Initial render
                updateResults();

                // Load saved filters
                const savedFilters = Storage.loadFilters();
                if (savedFilters) {
                    // Restore filters (simplified for now)
                    if (savedFilters.search) {
                        searchInput.value = savedFilters.search;
                        Filters.setSearch(savedFilters.search);
                    }
                }

            } catch (error) {
                console.error('Error initializing app:', error);
                document.getElementById('resultsGrid').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ö†Ô∏è</div>
                        <div class="empty-state-text">Error loading application</div>
                    </div>
                `;
            }
        }

        // Update results display
        function updateResults() {
            const allSatellites = Indexer.getAll();
            const filtered = Filters.apply(allSatellites);

            UI.renderCards(filtered, document.getElementById('resultsGrid'));
            UI.updateResultsCount(filtered.length, document.getElementById('resultsCount'));
            UI.renderFilterChips(document.getElementById('filterChips'));
        }

        // Initialize sidebar toggle functionality
        function initSidebarToggle() {
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.getElementById('sidebarToggle');
            const content = document.querySelector('.content');
            const toggleIcon = toggleBtn.querySelector('.toggle-icon');
            
            // Load saved state
            const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
            if (isCollapsed) {
                sidebar.classList.add('collapsed');
                content.classList.add('sidebar-collapsed');
                toggleIcon.textContent = '‚ñ∂';
            }
            
            // Toggle on click
            toggleBtn.addEventListener('click', () => {
                const isCollapsed = sidebar.classList.toggle('collapsed');
                content.classList.toggle('sidebar-collapsed');
                toggleIcon.textContent = isCollapsed ? '‚ñ∂' : '‚óÄ';
                localStorage.setItem('sidebarCollapsed', isCollapsed);
                
                // Trigger map resize after animation
                setTimeout(() => {
                    if (window.MapManager && window.MapManager.map) {
                        window.MapManager.map.invalidateSize();
                    }
                }, 300);
            });
        }

        // Start the app
        init();
    </script>
</body>
</html>
