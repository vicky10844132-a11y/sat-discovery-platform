# SAT-DISCOVERY 架构设计 - 无存储算法处理平台

## 核心理念

**定位**: 遥感数据算法处理平台（Processing-as-a-Service）  
**原则**: 不存储数据，只做计算  
**模式**: 类似 Google Earth Engine 和 Sentinel Hub Processing API

## 架构原则

### ❌ 不做的事情
- **不存储输入数据** - 从外部源直接调用
- **不存储输出数据** - 生成临时下载链接后自动清理
- **不托管影像** - 所有数据都在原始提供者处
- **不提供长期存储** - 仅临时处理空间（24小时）

### ✅ 做的事情
- **算法执行** - 提供35+种遥感处理算法
- **参数配置** - 用户友好的配置界面
- **任务调度** - 异步处理，进度跟踪
- **结果交付** - 临时下载链接（24小时有效）

## 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                         用户界面                             │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │
│  │ 数据源   │  │ 算法目录 │  │ 任务配置 │  │ 结果查看 │   │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘   │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                      API Gateway                             │
│              /api/algorithms  /api/submit                    │
│              /api/status      /api/download                  │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                      任务队列 (Redis)                        │
│                  Bull Queue / AWS SQS                        │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                   算法执行器 (Serverless)                     │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │ AWS Lambda   │  │ Google       │  │ Azure        │     │
│  │ + GDAL Layer │  │ Cloud Func   │  │ Functions    │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
└─────────────────────────────────────────────────────────────┘
        ↓                    ↓                    ↓
┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│ 外部数据源    │    │ 临时处理空间  │    │ 结果存储      │
│ STAC / S3    │    │ Lambda /tmp  │    │ S3 (24h TTL)  │
│ HTTP URL     │    │ GCS 临时桶    │    │ 预签名URL     │
└──────────────┘    └──────────────┘    └──────────────┘
```

## 工作流程

### 1. 用户提交任务

```json
{
  "algorithm": "ndvi",
  "input": {
    "type": "stac",
    "url": "https://earth-search.aws.element84.com/v1",
    "collection": "sentinel-2-l2a",
    "bbox": [120.0, 30.0, 121.0, 31.0],
    "datetime": "2024-01-01/2024-01-31"
  },
  "parameters": {
    "output_format": "GeoTIFF",
    "compression": "LZW"
  }
}
```

### 2. 任务入队

- 验证参数
- 生成任务 ID
- 添加到队列
- 返回任务 ID 给用户

### 3. 异步处理

**Lambda 函数执行**:
```python
def lambda_handler(event, context):
    # 1. 从外部源获取数据（不下载，流式处理）
    stac_item = fetch_stac_item(event['input'])
    
    # 2. 读取所需波段到内存（/tmp 临时空间）
    red = load_band(stac_item, 'red')
    nir = load_band(stac_item, 'nir')
    
    # 3. 执行算法
    ndvi = (nir - red) / (nir + red)
    
    # 4. 保存到临时 S3（24小时过期）
    result_url = save_to_temp_s3(ndvi, expiry=24)
    
    # 5. 清理 /tmp
    cleanup_temp_files()
    
    return {
        'status': 'completed',
        'result_url': result_url,
        'expires_at': '2024-XX-XX'
    }
```

### 4. 结果交付

- 生成预签名下载 URL（24小时有效）
- 用户下载结果
- 24小时后自动删除

## 技术栈

### 前端
- **框架**: 纯 HTML/CSS/JavaScript（无框架）
- **地图**: Leaflet.js
- **UI**: 暗色主题 + 黄色强调

### 后端（Serverless）
- **API**: AWS API Gateway / Vercel Functions
- **计算**: AWS Lambda / Google Cloud Functions
- **队列**: Redis (Bull) / AWS SQS
- **临时存储**: S3 (lifecycle policy) / GCS

### 算法环境
- **运行时**: Python 3.11 + GDAL 3.6
- **库**:
  - `rasterio` - 栅格 I/O
  - `numpy` - 数值计算
  - `scipy` - 科学计算
  - `GDAL` - 地理数据处理
  - `pyroSAR` - SAR 处理
  - `scikit-image` - 图像处理
  - `xarray` - 时间序列

## 成本估算

### AWS Lambda 模式

**每次处理成本**:
- Lambda 执行: $0.0000166667 × 1024 MB × 60s = ~$0.001
- S3 存储（24小时）: $0.023/GB × 0.5 GB × 1天 = ~$0.0003
- 数据传输: ~$0.001
- **单次总成本**: ~$0.002 (约 ¥0.014)

**月度成本**（处理1000次）:
- 计算: $2
- 存储: $0.3
- 传输: $1
- API Gateway: $3.5
- **总计**: ~$7/月 (约 ¥50)

**月度成本**（处理10000次）:
- 计算: $20
- 存储: $3
- 传输: $10
- API Gateway: $35
- **总计**: ~$68/月 (约 ¥480)

### Google Cloud Functions 模式

类似成本结构，略低：
- 1000次/月: ~$5
- 10000次/月: ~$50

## 数据流

### 输入数据源

1. **STAC API** (推荐)
   ```
   用户 → 选择 STAC Collection → 
   Lambda 读取 STAC Item → 
   直接处理 COG URL → 
   无需下载完整文件
   ```

2. **直接 URL**
   ```
   用户 → 提供 COG/GeoTIFF URL → 
   Lambda 流式读取 → 
   处理 → 
   结果
   ```

3. **用户上传**（临时）
   ```
   用户 → 上传到临时 S3 → 
   处理 → 
   清理输入文件
   ```

### 输出格式

- **GeoTIFF** (默认)
- **Cloud-Optimized GeoTIFF**
- **PNG** (可视化)
- **GeoJSON** (矢量结果)
- **统计 JSON** (数值结果)

## 限制与配额

### 免费额度
- 每用户：100次/月
- 单次任务：< 5分钟
- 输出文件：< 500 MB

### 付费用户
- 无限次数
- 单次任务：< 30分钟
- 输出文件：< 5 GB

## 安全考虑

### 数据安全
- ✅ 不存储用户数据
- ✅ 临时文件24小时后自动删除
- ✅ 预签名 URL 防止未授权访问
- ✅ HTTPS 加密传输

### 资源保护
- ✅ API Key 认证
- ✅ 速率限制（100次/小时）
- ✅ Lambda 超时保护
- ✅ 最大内存限制

## 扩展性

### 横向扩展
- Lambda 自动扩展（0-1000实例）
- 无服务器架构，按需付费
- 无单点故障

### 算法扩展
- 插件式架构
- 新算法作为独立 Lambda 函数
- 版本化管理

## 对比其他平台

| 特性 | SAT-DISCOVERY | Google Earth Engine | Sentinel Hub |
|------|---------------|---------------------|--------------|
| 数据存储 | ❌ 无 | ✅ PB级 | ❌ 无 |
| 算法数量 | 35+ | 500+ | 20+ |
| 自定义算法 | ✅ 开放 | ⚠️ 有限 | ⚠️ 有限 |
| 成本 | $50/月 | 免费（研究） | $0.1/km² |
| 开源 | ✅ MIT | ❌ | ❌ |
| 部署 | 自托管 | 云端 | SaaS |

## 实施路线图

### Phase 1: 静态前端（已完成）
- ✅ 数据源目录
- ✅ 算法目录
- ✅ UI 设计

### Phase 2: Serverless 后端（2周）
- [ ] API Gateway 设置
- [ ] Lambda 函数开发
- [ ] 算法实现（NDVI, NDWI等）
- [ ] 临时存储配置

### Phase 3: 前端集成（1周）
- [ ] 任务提交界面
- [ ] 进度跟踪
- [ ] 结果下载
- [ ] 错误处理

### Phase 4: 高级功能（2周）
- [ ] 用户认证
- [ ] 配额管理
- [ ] 历史记录
- [ ] 批量处理

## 总结

**SAT-DISCOVERY 是一个无存储的算法处理平台**:
- 📊 整合全球开源数据源
- 🔧 提供35+种处理算法
- ☁️ Serverless 架构，按需扩展
- 💰 低成本运营（$50-200/月）
- 🔓 完全开源，社区驱动
- 🚫 不存储数据，只做计算

**适用场景**:
- 研究人员快速处理分析
- 小型项目原型开发
- 教育培训演示
- 开源社区贡献

**不适用场景**:
- 需要长期存储
- PB 级数据处理
- 实时流处理
- 高度定制化需求
